# Hardware Signer

The `HardwareSigner` is designed to leverage the hardware security features of your device, such as the Secure Enclave on iOS or the Android Keystore on Android devices. This provides an additional layer of security when signing payloads, as the private key material never leaves the secure environment of the device's hardware.

## Generating a Keypair

Before you can start signing payloads, you need to generate a keypair associated with your app. This is done using the `generateKeyPair` method:

```dart
final HardwareSigner hwdSigner = HardwareSigner.withTag("my_app_tag");
final P256Credential credential = await hwdSigner.generateKeyPair();
```

The `generateKeyPair` method returns a `P256Credential` instance, which contains the following properties:

- `tag`: The tag associated with the credential.
- `credentialDer`: The credential in DER format as a `Uint8List`.
- `credentialRaw`: The raw credential as a `Uint8List`.
- `publicKey`: A tuple containing the x and y coordinates of the public key as `Uint256` instances.

## Checking if a Keypair Exists

Before generating a new keypair, you can check if a keypair already exists for your app's tag using the `isKeyCreated` method:

```dart
final HardwareSigner hwdSigner = HardwareSigner.withTag("my_app_tag");
final bool isCreated = await hwdSigner.isKeyCreated();
print("Keypair created: $isCreated");
```

## Retrieving the Public Key

If you already have a keypair generated, you can retrieve the public key associated with it using the `getPublicKey` method:

```dart
final HardwareSigner hwdSigner = HardwareSigner.withTag("my_app_tag");
final publicKey = await hwdSigner.getPublicKey();
print("Public Key X: ${publicKey.item1.toHex()}");
print("Public Key Y: ${publicKey.item2.toHex()}");
```

## Signing Payloads

The `HardwareSigner` provides three methods for signing payloads:

::::steps

### Using personalSign

The `personalSign` method signs the provided hash using the device's hardware and returns the signature as a `Uint8List`.

```dart
final HardwareSigner hwdSigner = HardwareSigner.withTag("my_app_tag");
final Uint8List payload = Uint8List.fromList([0x12, 0x34, 0x56, 0x78]);
final Uint8List signature = await hwdSigner.personalSign(payload);
print("Signature: $signature");
```

### Using signToEc

The `signToEc` method signs the provided hash using the device's hardware and returns an instance of `MsgSignature` containing the `r`, `s`, and `v` values of the signature.

```dart
final HardwareSigner hwdSigner = HardwareSigner.withTag("my_app_tag");
final Uint8List payload = Uint8List.fromList([0x12, 0x34, 0x56, 0x78]);
final MsgSignature signature = await hwdSigner.signToEc(payload);
print("r: ${signature.r}, s: ${signature.s}, v: ${signature.v}");
```

### Using signToP256Signature

The `signToP256Signature` method signs the provided hash using the device's hardware and returns a `P256Signature` instance, which contains the following properties:

- `signedPayload`: The signed payload as a `Uint8List`.
- `signatureRaw`: The raw signature as a `Uint8List`.
- `r`: The r value of the signature as a `Uint256`.
- `s`: The s value of the signature as a `Uint256`.

```dart
final HardwareSigner hwdSigner = HardwareSigner.withTag("my_app_tag");
final Uint8List payload = Uint8List.fromList([0x12, 0x34, 0x56, 0x78]);
final P256Signature signature = await hwdSigner.signToP256Signature(payload);
print("Signed Payload: ${signature.signedPayload}");
print("Signature Raw: ${signature.signatureRaw}");
print("r: ${signature.r.value}, s: ${signature.s.value}");
```

The `P256Signature` class also provides a `toUint8List` method that converts the signature to a `Uint8List` using ABI encoding, which can be used for on-chain verification.

```dart
final Uint8List encodedSignature = signature.toUint8List();
print("Encoded Signature: $encodedSignature");
```

::::

## Verifying Signatures

To verify the payload on the blockchain successfully, you must verify against the `SHA256` hash of the payload. The `P256Signature` class provides a `toUint8List` method that returns the ABI-encoded representation of the signature, which can be used for on-chain verification.

## Securely Storing Credentials

The `P256Credential` class represents the credential generated by the `HardwareSigner`. It contains sensitive information, such as the public key and raw credential data. It's crucial to securely store or transmit this data to prevent unauthorized access or tampering.

You can serialize the `P256Credential` to JSON format using the `toJson` method, and deserialize it using the `P256Credential.fromJson` constructor:

```dart
final String credentialJson = credential.toJson();
// Store or transmit the JSON representation securely

// Later, deserialize the credential
final P256Credential restoredCredential = P256Credential.fromJson(credentialJson);
```
